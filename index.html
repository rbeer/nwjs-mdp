<!DOCTYPE html>
<html>
  <head>
    <title>nwjs/m/p</title>
    <link rel="stylesheet" type="text/css" href="./styles/animations.css" />
    <link rel="stylesheet" type="text/css" href="./styles/ui.css" />
    <link rel="stylesheet" type="text/css" href="./styles/git-flavored.css" />
    <link rel="stylesheet" type="text/css" href="./lib/font-awesome/css/font-awesome.min.css" />
    <script>
      let parseArgv = (args) => {
        let options = {
          i: '',        // no standard input file; -i ''
          w: true,      // auto attach file-watcher; -w true
        };
        for (let key in options) {
          let flagIdx = args.indexOf('-' + key);
          if (flagIdx > -1) {
            options[key] = args[flagIdx + 1];
          }
        }
        return options;
      };

      let _init = () => {
        const gui = require('nw.gui');
        const options = parseArgv(gui.App.argv);
        const inputPath = options.i;

        if (!inputPath) {
          alert(`Can't read from ${inputPath}.`);
          inputPath = './README.md';
        };

        const app = {
          UI: require('./ui.js'),
          RenderRequest: require('./render-request.js')
        };

        const request = new app.RenderRequest(inputPath, 'raw');

        app.render = () => {
          app.UI.toggleRequestAnimation(true);
          request.compile().then((req) => {
            app.UI.setContent(req.compiledHTMLDocument);
            app.UI.flashContent();
          })
          .catch((err) => {
            console.log(err);
          })
          .finally(app.UI.toggleRequestAnimation);
        };

        app.toggleFilewatcher = () => {
          let state = request.fileWatcher ? false : true;
          if (state) {
            request.startFileWatcher((type, fileName) => {
              if (type === 'change') {
                request.updateInput()
                .then(app.render)
                .catch((err) => {});
              }
            });
          } else {
            request.stopFileWatcher();
          }
          app.UI.toggleFilewatcher(state);
        };

        app.showRawModal = () => {
          app.UI.showRawModal(request.compiled);
        };

        app.close = () => gui.App.quit();

        window.app = app;
        window.clipboard = gui.Clipboard.get();

        app.UI.init(window);
        app.render();
        if (options.w) {
          app.toggleFilewatcher();
        }
      };
      document.addEventListener('DOMContentLoaded', _init);
    </script>
  </head>
  <body>
    <titlebar>
      <i class="fa markdown-mark"></i>
      <i class="fa fa-pull-right fa-times" onclick="app.close();"></i>
      <div class="divider-vertical"></div>
      <i class="fa fa-pull-right fa-chain-broken" onclick="app.toggleFilewatcher();" data-filewatcher></i>
      <div class="divider-vertical"></div>
      <i class="fa fa-pull-right fa-hashtag" onclick="app.showRawModal();"></i>
      <i class="fa fa-pull-right fa-refresh" onclick="app.render();" data-refresh></i>
    </titlebar>
    <container>
      <content>
      </content>
      <rawmodal>
        <textarea id="compiled_raw" readonly></textarea>
        <button class="copy-raw"><i class="fa fa-copy"></i></button>
      </rawmodal>
    </container>
  </body>
</html>
